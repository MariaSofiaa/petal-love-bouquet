<div class="background-container"></div>

<main>
    <div class="content-wrapper">
        <!-- Header bar for perfect vertical alignment -->
        <header class="header-bar">
            <button class="back-btn" (click)="goBack()" aria-label="Go back">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 class="page-title">Create your bouquet</h1>
            <div class="header-spacer"></div>
        </header>

        <!-- Stepper -->
        <div class="stepper-container animate-fade-up">
            <div class="stepper-item" [class.active]="currentStep === 1">
                <div class="flower-icon" [class.inactive]="currentStep < 1">
                    <img src="assets/flower-pink-cosmos.png" alt="Song">
                </div>
            </div>
            <div class="stepper-item" [class.active]="currentStep === 2">
                <div class="flower-icon" [class.inactive]="currentStep < 2">
                    <img src="assets/flower-red-hibiscus.png" alt="Message">
                </div>
            </div>
            <div class="stepper-item" [class.active]="currentStep === 3">
                <div class="flower-icon" [class.inactive]="currentStep < 3">
                    <img src="assets/flower-pink-tulip.png" alt="Puzzle">
                </div>
            </div>
            <div class="stepper-item" [class.active]="currentStep === 4">
                <div class="flower-icon" [class.inactive]="currentStep < 4">
                    <img src="assets/flower-white-daisy.png" alt="Drawing">
                </div>
            </div>
        </div>

        <!-- Step 1: Song Form Card -->
        <div *ngIf="currentStep === 1" class="card animate-fade-up" style="animation-delay: 0.1s">
            <div class="card-header">
                <div class="icon-circle" style="background: #a68b6c;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13" />
                        <circle cx="6" cy="18" r="3" />
                        <circle cx="18" cy="16" r="3" />
                    </svg>
                </div>
                <div class="title-group">
                    <h2>Choose a song</h2>
                    <p>Dedicate their favorite song</p>
                </div>
            </div>

            <div class="input-container">
                <label for="song-link">
                    <span class="link-icon">üîó</span>
                    YouTube or Spotify link *
                </label>
                <input type="text" id="song-link" [(ngModel)]="songLink"
                    placeholder="https://youtube.com/watch?v=... o https://open.spotify.com/..." class="song-input">
            </div>

            <div class="info-note">
                <span class="light-icon">üí°</span>
                <p>Copy the song link from YouTube or Spotify and paste it here</p>
            </div>
        </div>

        <!-- Step 2: Message Form Card -->
        <div *ngIf="currentStep === 2" class="card animate-fade-up" style="animation-delay: 0.1s">
            <div class="card-header">
                <div class="icon-circle" style="background: #4a6741;"> <!-- Different color for message step -->
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                        <polyline points="22,6 12,13 2,6" />
                    </svg>
                </div>
                <div class="title-group">
                    <h2>Write your letter</h2>
                    <p>Express your feelings (max. 100 characters)</p>
                </div>
            </div>

            <div class="input-container message-container">
                <textarea id="message-text" [(ngModel)]="message" placeholder="Write your love message here..."
                    class="message-input" maxlength="100"></textarea>
                <div class="decorative-heart">‚ô•</div>
            </div>

            <div class="char-count" [class.limit-reached]="message.length >= 100">
                {{message.length}}/100
            </div>
        </div>

        <!-- Step 3: Puzzle Preview Card -->
        <div *ngIf="currentStep === 3" class="card animate-fade-up" style="animation-delay: 0.1s">
            <div class="card-header">
                <div class="icon-circle" style="background: #a68b6c;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                    </svg>
                </div>
                <div class="title-group">
                    <h2>Preview: Puzzle</h2>
                    <p>This is how your special person will see it</p>
                </div>
            </div>

            <div class="puzzle-preview-container">
                <img src="/assets/puzzle.png" alt="Puzzle Preview" class="puzzle-preview-img">
            </div>

            <div class="interactive-info-box">
                <div class="info-header">
                    <span class="puzzle-emoji">üß©</span>
                    <h3>Interactive Activity</h3>
                </div>
                <p class="info-description">
                    The person who receives your bouquet will be able to drag and move the pieces to form a complete
                    heart.
                </p>
                <ul class="info-list">
                    <li>‚ú® 2x2 piece puzzle</li>
                    <li>‚ù§Ô∏è Forms a heart when completed</li>
                    <li>üì± Works on mobile and desktop</li>
                </ul>
            </div>

            <div class="info-note mini-note">
                <span class="light-icon">üí°</span>
                <p>Nothing to configure here. This puzzle will be automatically included in your bouquet.</p>
            </div>
        </div>


        <!-- Step 4: Drawing/Upload Card -->
        <div *ngIf="currentStep === 4" class="card animate-fade-up" style="animation-delay: 0.1s">
            <div class="card-header">
                <div class="icon-circle" style="background: #4a6741;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z" />
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
                        <path d="M2 2l5 5" />
                        <circle cx="11" cy="11" r="2" />
                    </svg>
                </div>
                <div class="title-group">
                    <h2>Draw your love</h2>
                    <p>Create something unique and special</p>
                </div>
            </div>

            <!-- Mode Toggle (Disabled for V4 ultra-short links) -->
            <!-- <div class="mode-toggle">
                <button [class.active]="activeMode === 'draw'" (click)="setMode('draw')">
                    üé® Draw
                </button>
                <button [class.active]="activeMode === 'upload'" (click)="setMode('upload')">
                    üñºÔ∏è Upload
                </button>
            </div> -->

            <div class="drawing-interface" *ngIf="activeMode === 'draw'">
                <div class="canvas-container">
                    <canvas #drawingCanvas (mousedown)="startDrawing($event)" (mousemove)="draw($event)"
                        (mouseup)="stopDrawing()" (mouseleave)="stopDrawing()" (touchstart)="startDrawing($event)"
                        (touchmove)="draw($event)" (touchend)="stopDrawing()">
                    </canvas>
                    <div class="canvas-grid"></div>
                </div>

                <div class="drawing-tools">
                    <div class="tool-section">
                        <label>Color</label>
                        <div class="color-palette">
                            <button *ngFor="let color of colors" [style.background]="color"
                                [class.active]="selectedColor === color" (click)="selectedColor = color">
                            </button>
                        </div>
                    </div>

                    <div class="tool-section brush-section">
                        <label>Brush size: <span>{{brushSize}}px</span></label>
                        <input type="range" min="1" max="20" [(ngModel)]="brushSize" class="brush-slider">
                    </div>

                    <div class="tool-actions">
                        <!-- <button class="btn-tool btn-download" (click)="downloadDrawing()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
                            </svg>
                            Download
                        </button> -->
                        <button class="btn-tool btn-clear" (click)="clearCanvas()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Commented out for V4 Vector drawing links
            <div class="upload-interface" *ngIf="activeMode === 'upload'">
                ...
            </div>
            -->

            <div class="info-note mini-note">
                <span class="light-icon">üí°</span>
                <p>Use your finger or mouse to draw your special message.</p>
            </div>
        </div>


        <!-- Action Section -->
        <div class="action-group animate-fade-up" style="animation-delay: 0.2s">
            <button class="btn-next"
                [disabled]="(currentStep === 1 && !isValidLink()) || (currentStep === 2 && !isValidMessage())"
                (click)="nextStep()" appRipple>
                {{ currentStep === 4 ? 'Finish bouquet' : 'Next flower' }}
                <span class="next-arrow">‚ûî</span>
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" *ngIf="showSuccessModal" (click)="$event.stopPropagation()">
        <div class="modal-card animate-zoom-in">
            <div class="celebration-icon">
                <div class="confetti-bg">üéâ</div>
            </div>

            <div class="modal-content">
                <h2>Bouquet Created!</h2>
                <p class="modal-subtitle">Your love bouquet is ready to share üíï</p>

                <div class="link-section">
                    <label>Share this link:</label>
                    <div class="link-input-group">
                        <input type="text" [value]="shareableLink" readonly>
                        <button class="btn-copy" (click)="copyLink()" [class.copied]="isLinkCopied" title="Copy link">
                            <svg *ngIf="!isLinkCopied" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path
                                    d="M8 4v12a2 2 0 002 2h8a2 2 0 002-2V7.242a2 2 0 00-.602-1.43L16.083 2.57A2 2 0 0014.653 2H10a2 2 0 00-2 2z" />
                                <path d="M16 18v2a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2" />
                            </svg>
                            <svg *ngIf="isLinkCopied" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-home" (click)="goHome()" appRipple>
                        <span class="home-icon">‚ûî</span>
                        Back to home
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>